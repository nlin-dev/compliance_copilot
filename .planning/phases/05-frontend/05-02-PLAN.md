---
phase: 05-frontend
plan: 02
type: execute
---

<objective>
Add source citations to chat messages so users can see where answers come from.

Purpose: Compliance professionals need to verify information sources. Displaying CMS manual citations builds trust and enables fact-checking.
Output: Chat messages display collapsible source cards with page numbers and sections.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior work (03-02):**
- Query API streams text but sources are built but not sent to client
- Sources array built at line 129-135 in route.ts but only used for caching
- Hook useChatStream only reads streaming text, no source parsing

**Key files:**
@src/app/api/query/route.ts
@src/hooks/use-chat-stream.ts
@src/components/chat/message-bubble.tsx
@src/lib/schemas/query.ts

**Decision:** Append sources as JSON after stream completion using a delimiter marker.
Format: `\n__SOURCES__\n{json array}` at end of stream.
Frontend parses this to extract sources separately from answer text.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify query API to send sources after stream</name>
  <files>src/app/api/query/route.ts</files>
  <action>
    After the streaming loop completes (after line 150), append a sources marker and JSON to the stream:
    1. Define SOURCES_MARKER = '\n__SOURCES__\n'
    2. After all content chunks are yielded, encode and enqueue:
       - SOURCES_MARKER
       - JSON.stringify(sources)
    3. Then call controller.close()

    This ensures sources are sent after the full answer but before stream ends.
    No changes needed to caching logic (it already stores sources separately).
  </action>
  <verify>curl -X POST http://localhost:3000/api/query -H "Content-Type: application/json" -d '{"query":"what is homebound status"}' shows answer text followed by __SOURCES__ marker and JSON array</verify>
  <done>API stream includes sources JSON after answer text with __SOURCES__ delimiter</done>
</task>

<task type="auto">
  <name>Task 2: Update chat hook to parse sources from stream</name>
  <files>src/hooks/use-chat-stream.ts, src/hooks/use-chat-stream.test.ts</files>
  <action>
    1. Update Message interface to include optional sources array:
       sources?: { text: string; pageNumber: number; section?: string; subsection?: string; score: number }[]
    2. In sendMessage, after streaming loop:
       - Check if content contains '__SOURCES__'
       - If found, split on marker: [answerText, sourcesJson]
       - Parse sourcesJson as array
       - Update assistant message with both content (answer only) and sources
    3. Update test file to verify sources parsing
  </action>
  <verify>npm test -- use-chat-stream passes, including new sources parsing tests</verify>
  <done>Hook parses sources from stream, Message type includes sources, tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create SourceCard and display in messages</name>
  <files>src/components/chat/source-card.tsx, src/components/chat/message-bubble.tsx</files>
  <action>
    1. Create src/components/chat/source-card.tsx:
       - Collapsible card using shadcn Collapsible component (may need to add: npx shadcn@latest add collapsible)
       - Shows section/subsection as header
       - Collapsed by default, expands to show full text
       - Include page number badge
       - Style with muted background
    2. Update src/components/chat/message-bubble.tsx:
       - Import SourceCard
       - For assistant messages with sources, render source cards below answer
       - Add "Sources ({n})" header above source cards
       - Only show sources section if message.sources exists and has items
  </action>
  <verify>npm run dev - send a query, verify sources appear as collapsible cards below the answer</verify>
  <done>Assistant messages show collapsible source cards with section headers, page numbers, and expandable text</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests including new sources tests
- [ ] Sending a query shows answer followed by source cards
- [ ] Source cards are collapsed by default
- [ ] Clicking a source card expands to show full text
- [ ] Page numbers and sections visible in source cards
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Sources displayed clearly below chat answers
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend/05-02-SUMMARY.md`
</output>
